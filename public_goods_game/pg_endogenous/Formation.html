{{ block title }}Firm formation{{ endblock }}

{{ block content }}

<div class="alert alert-info">
    Click “Apply” to join a firm. If you are the owner of a firm, you can accept/reject applicants.
</div>

<div id="alertBox" class="alert alert-warning" style="display:none;"></div>

<!-- Resume panel -->
<div class="card mb-3">
    <div class="card-body">
        <div class="mb-2">
            <b>View resume:</b>
            <select id="resumeSelect" class="form-select form-select-sm"
                    style="max-width: 260px; display:inline-block;"></select>
        </div>
        <div id="resumeArea" class="text-muted">Waiting for data...</div>
    </div>
</div>

<table class="table table-sm">
    <thead>
    <tr>
        <th>Firm (owner)</th>
        <th>Status</th>
        <th>Employed (incl. owner)</th>
        <th>Pending applicants</th>
        <th>Action</th>
        <th>Owner controls</th>
    </tr>
    </thead>
    <tbody id="firmsBody"></tbody>
</table>

{{ endblock }}

{{ block scripts }}
<script>
    const myId = js_vars.my_id;
    const maxSize = js_vars.max_size;

    let latestState = null;

    function showAlert(msg) {
        const box = document.getElementById('alertBox');
        box.textContent = msg;
        box.style.display = msg ? 'block' : 'none';
    }

    function fmt2(x) {
        if (x === null || x === undefined) return '';
        const num = Number(x);
        if (Number.isNaN(num)) return '';
        return num.toFixed(2);
    }

    function sendApply(owner) {
        liveSend({type: 'apply', owner: owner});
    }
    function sendWithdraw(owner) {
        liveSend({type: 'withdraw', owner: owner});
    }
    function sendAccept(owner, applicant) {
        liveSend({type: 'accept', owner: owner, applicant: applicant});
    }
    function sendReject(owner, applicant) {
        liveSend({type: 'reject', owner: owner, applicant: applicant});
    }

    function renderResume() {
        if (!latestState) return;

        const sel = document.getElementById('resumeSelect');
        const targetId = String(sel.value);

        const resumes = latestState.resumes || {};
        const hist = resumes[targetId] || [];

        if (!hist.length) {
            document.getElementById('resumeArea').innerHTML = `<div class="text-muted">No history yet.</div>`;
            return;
        }

        const rows = hist.map(r => `
            <tr>
                <td>${r.round}</td>
                <td>${r.firm_owner_id ?? 0}</td>
                <td>${r.firm_size ?? ''}</td>
                <td>${r.firm_members ?? ''}</td>
                <td>${fmt2(r.per_capita_effort)}</td>
                <td>${fmt2(r.per_capita_payout)}</td>
                <td>${r.was_terminated ? 'YES' : ''}</td>
            </tr>
        `).join('');

        document.getElementById('resumeArea').innerHTML = `
            <table class="table table-sm">
                <thead>
                <tr>
                    <th>Period</th>
                    <th>Firm owner</th>
                    <th>Size</th>
                    <th>Members</th>
                    <th>Per-capita effort</th>
                    <th>Per-capita payout</th>
                    <th>Terminated</th>
                </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
        `;
    }

    function ensureResumeDropdown(state) {
        const sel = document.getElementById('resumeSelect');
        if (sel.options.length > 0) return;

        const ids = state.all_ids || [];
        for (const id of ids) {
            const opt = document.createElement('option');
            opt.value = id;
            opt.textContent = `Participant ${id}`;
            sel.appendChild(opt);
        }
        sel.value = String(myId);
        sel.addEventListener('change', renderResume);
    }

    function render(state) {
        latestState = state;

        ensureResumeDropdown(state);
        renderResume();

        const firms = state.firms;
        const employer = state.employer;   // keys are strings
        const outgoing = state.outgoing;

        const myEmployer = employer[String(myId)];
        const myOutgoing = outgoing[String(myId)] || [];

        const tbody = document.getElementById('firmsBody');
        tbody.innerHTML = '';

        for (const firm of firms) {
            const owner = firm.owner;
            const active = firm.active;
            const members = firm.members;
            const pending = firm.pending;
            const slotsLeft = firm.slots_left;

            const tr = document.createElement('tr');
            if (!active) tr.classList.add('text-muted');

            const statusText = active ? `Active (slots left: ${slotsLeft})` : 'Inactive (owner employed elsewhere)';

            let actionHtml = '';
            const iAppliedHere = myOutgoing.includes(owner);
            const canTryApply = (myEmployer === null) && (owner !== myId) && active;

            if (iAppliedHere) {
                actionHtml = `<button type="button" class="btn btn-sm btn-secondary" onclick="sendWithdraw(${owner})">Withdraw</button>`;
            } else if (canTryApply) {
                actionHtml = `<button type="button" class="btn btn-sm btn-primary" onclick="sendApply(${owner})">Apply</button>`;
            } else {
                actionHtml = `<span class="text-muted">—</span>`;
            }

            let ownerControls = '<span class="text-muted">—</span>';
            if (owner === myId && active) {
                if (pending.length === 0) {
                    ownerControls = '<span class="text-muted">(no applicants)</span>';
                } else {
                    ownerControls = pending.map(a => {
                        return `
                          <div class="mb-1">
                            Applicant ${a}
                            <button type="button" class="btn btn-sm btn-success" onclick="sendAccept(${owner}, ${a})">Accept</button>
                            <button type="button" class="btn btn-sm btn-danger" onclick="sendReject(${owner}, ${a})">Reject</button>
                          </div>`;
                    }).join('');
                }
            }

            tr.innerHTML = `
                <td>#${owner}</td>
                <td>${statusText}</td>
                <td>${members.join(', ')}</td>
                <td>${pending.length ? pending.join(', ') : '<span class="text-muted">none</span>'}</td>
                <td>${actionHtml}</td>
                <td>${ownerControls}</td>
            `;
            tbody.appendChild(tr);
        }
    }

    // Make liveRecv explicitly global
    window.liveRecv = function(data) {
        if (data.alert) {
            showAlert(data.alert);
        }
        if (data.state) {
            showAlert('');
            render(data.state);
        }
    }

    // ping for initial state
    liveSend({type: 'ping'});
</script>
{{ endblock }}
